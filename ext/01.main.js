oxfApp.config.tagDropdown = "block_dropdown";
oxfApp.config.tagTextCenter = "block_text_center";
oxfApp.config.tagTextUpCenter = "block_text_up_center";
oxfApp.config.tagTextUpLeft = "block_text_up_left";
oxfApp.config.tagTextUpRight = "block_text_up_right";
oxfApp.config.tagBackgroundColorHelp = "home_help_background_color_";
oxfApp.config.tagBorderColorHelp = "home_help_border_color_";
oxfApp.config.tagBlockEbook = "block_ebook";
oxfApp.config.tagBlockEbooks = "block_ebooks";
oxfApp.config.cardView = "cards_view";
oxfApp.config.evauAbstracts = "evau_abstracts";
oxfApp.config.evauExams = "evau_exams";
oxfApp.config.examsOnline = "exams_online";


oxfApp.icons.units = '<svg xmlns="http://www.w3.org/2000/svg" width="72.607" height="55.322"><path data-name="Libro tab bar" d="M68.122 48.414h-.672v-2a3.778 3.778 0 0 0-3.942-3.579H55.38a2.042 2.042 0 0 0-2.085-1.684H46.65a2.042 2.042 0 0 0-2.085 1.684h-.656a8.82 8.82 0 0 0-7.583 4.081 8.82 8.82 0 0 0-7.583-4.081H9.1a3.778 3.778 0 0 0-3.942 3.579v2h-.673A4.3 4.3 0 0 0 0 52.486V92.4a4.3 4.3 0 0 0 4.485 4.07h63.637a4.3 4.3 0 0 0 4.485-4.07V52.486a4.3 4.3 0 0 0-4.485-4.072zm-24.213-3.651h.641v12.69a1.847 1.847 0 0 0 3.092 1.178l2.332-2.077 2.326 2.077a1.847 1.847 0 0 0 3.1-1.178v-5.817a1.069 1.069 0 0 0-2.127 0v5.148l-2.023-1.8a1.963 1.963 0 0 0-2.547 0l-2.023 1.8V43.079h6.592v13.159c0 .533.476-4.6 1.063-4.6s1.064.533 1.064 0v-6.875h8.112a1.739 1.739 0 0 1 1.815 1.647v41.823a1.739 1.739 0 0 1-1.815 1.647H37.39V50.635c.026-3.24 2.94-5.872 6.519-5.872zM70.479 92.4a2.26 2.26 0 0 1-2.358 2.141H4.485A2.26 2.26 0 0 1 2.127 92.4V52.486a2.26 2.26 0 0 1 2.358-2.141h.672V79.7a1.018 1.018 0 0 0 1.064.966 1.018 1.018 0 0 0 1.063-.966V46.411A1.739 1.739 0 0 1 9.1 44.763h19.642c3.579 0 6.493 2.632 6.52 5.876V89.88H9.1a1.739 1.739 0 0 1-1.814-1.647V79.7a.751.751 0 0 0-.83-.862c-.588 0-1.3.329-1.3.862v8.535A3.778 3.778 0 0 0 9.1 91.811h54.41a3.778 3.778 0 0 0 3.942-3.579V50.345h.672a2.26 2.26 0 0 1 2.358 2.141z" transform="translate(0 -41.148)" style="fill:#02285c"/></svg>';
oxfApp.icons.resources = '<svg xmlns="http://www.w3.org/2000/svg" width="59.346" height="52.834"><defs><style>.cls-1{fill:#02285c}</style></defs><g id="ICON_contenidos_por_unidades" data-name="ICON contenidos por unidades" transform="translate(-5292.648 -791.102)"><g id="folder" transform="translate(5292.648 791.102)"><g id="Grupo_1216" data-name="Grupo 1216"><path id="Trazado_894" data-name="Trazado 894" class="cls-1" d="M55.39 178.69H3.956A4.1 4.1 0 0 1 0 174.475v-23.186c0-.582.442-.243.989-.243s.989-.338.989.243v23.186a2.048 2.048 0 0 0 1.978 2.108H55.39a2.048 2.048 0 0 0 1.978-2.108V140.75a2.048 2.048 0 0 0-1.978-2.108H3.956a2.048 2.048 0 0 0-1.978 2.108v10.539a1.023 1.023 0 0 1-.989 1.054A1.023 1.023 0 0 1 0 151.289V140.75a4.1 4.1 0 0 1 3.956-4.216H55.39a4.1 4.1 0 0 1 3.956 4.216v33.725a4.1 4.1 0 0 1-3.956 4.216" transform="translate(0 -125.856)"/><path id="Trazado_896" data-name="Trazado 896" class="cls-1" d="M36.264 44.725h51.117V42.96a1.975 1.975 0 0 0-2.13-1.765H55.988a2.4 2.4 0 0 1-1.733-.69l-4.128-4.276a1.149 1.149 0 0 0-.827-.329H38.394a1.975 1.975 0 0 0-2.13 1.765zm52.182 1.765H35.2c-.589 0-1.065 2.507-1.065 2.02V37.664c0-1.947 1.911-3.53 4.26-3.53H49.3a3.456 3.456 0 0 1 2.49.992l4.127 4.274 29.334.028c2.349 0 4.26 1.583 4.26 3.53v2.648a.986.986 0 0 1-1.065.883z" transform="translate(-34.134 -34.134)"/></g></g><path id="Trazado_897" data-name="Trazado 897" d="m221.4 144.324-12.926-8.079a1.616 1.616 0 0 0-2.472 1.37v16.158a1.615 1.615 0 0 0 2.472 1.37l12.926-8.079a1.616 1.616 0 0 0 0-2.74z" transform="translate(5110.242 677.102)" style="fill:none;stroke:#02285c;stroke-width:2px"/></g></svg>';
oxfApp.icons.lockUnlock = '<svg width="24" height="34" viewBox="0 0 24 34" xmlns="http://www.w3.org/2000/svg"><path d="M21.53 13.8H6.73V9a5.15 5.15 0 0 1 4-5.1A5 5 0 0 1 16.52 8c.051.28.078.565.08.85a1.65 1.65 0 1 0 3.29 0A8.25 8.25 0 0 0 11.63.6h-.78a8.53 8.53 0 0 0-7.4 8.55v4.6H1.8A1.65 1.65 0 0 0 .16 15.4v16.49a1.76 1.76 0 0 0 1.64 1.64h19.73a1.66 1.66 0 0 0 1.65-1.64V15.44a1.56 1.56 0 0 0-1.46-1.64h-.19Zm-8.22 11V27A1.655 1.655 0 1 1 10 27v-2.18A3.4 3.4 0 0 1 8.38 22a3.26 3.26 0 0 1 3.28-3.24c.28.001.56.038.83.11A3.72 3.72 0 0 1 15 21.36a3.21 3.21 0 0 1-1.69 3.46v-.02Z" fill="#8EC371" fill-rule="nonzero"/></svg>';
oxfApp.icons.lockLocked = '<svg width="24" height="34" viewBox="0 0 24 34" xmlns="http://www.w3.org/2000/svg"><path d="M22 13.8H7.24V9a5.15 5.15 0 0 1 3.95-5.1A5 5 0 0 1 17 8c.051.28.078.565.08.85v6h2l1.3.53V8.87A8.26 8.26 0 0 0 12.12.61h-.78A8.54 8.54 0 0 0 4 9.19v4.6H2.31a1.65 1.65 0 0 0-1.64 1.65v16.45a1.76 1.76 0 0 0 1.64 1.64H22a1.66 1.66 0 0 0 1.65-1.64V15.44a1.56 1.56 0 0 0-1.46-1.64H22Zm-8.22 11V27a1.65 1.65 0 1 1-3.29 0v-2.18A3.43 3.43 0 0 1 8.89 22a3.26 3.26 0 0 1 3.28-3.24c.28.001.56.038.83.11a3.72 3.72 0 0 1 2.47 2.47 3.19 3.19 0 0 1-1.65 3.48l-.04-.02Z" fill="#202E55" fill-rule="nonzero"/></svg>';
oxfApp.icons.eye = '<svg width="77" height="49" viewBox="0 0 77 49" xmlns="http://www.w3.org/2000/svg"><path d="M38.58 9.46A14.94 14.94 0 1 0 53.52 24.4c-.033-8.237-6.703-14.907-14.94-14.94Zm0-9.13c20.54 0 36.62 21.68 37.29 22.6a2.49 2.49 0 0 1 0 2.94c-.67.92-16.75 22.6-37.29 22.6S1.96 26.79 1.29 25.87a2.49 2.49 0 0 1 0-2.94C2 22 18.04.33 38.58.33Zm0 4.98c-15.11 0-28.24 14.38-32.11 19.09 3.88 4.7 16.98 19.09 32.11 19.09 15.16 0 28.23-14.38 32.11-19.09-3.88-4.71-17-19.09-32.11-19.09Zm0 9.05c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10Z" fill="#323232" fill-rule="nonzero"/></svg>';

oxfApp.text.oxford_geniox_pageperunit = "Páginas por unidad";
oxfApp.text.oxford_geniox_resourcesperunit = "Recursos por unidad";
oxfApp.text.oxford_geniox_showpins = "Mostrar pines";
oxfApp.text.oxford_geniox_showbookmenu = "Mostrar menú";
oxfApp.text.oxford_geniox_hidebookmenu = "Ocultar menú";
oxfApp.text.oxford_geniox_close = "Cerrar";
oxfApp.text.oxford_geniox_addresource = "Añade tu recurso";
oxfApp.text.oxford_geniox_pags = "Pág.";
oxfApp.text.oxford_geniox_downloadFile = "Descargar imprimible";
oxfApp.text.oxford_geniox_toggleVisibility = "Bloquear/Desbloquear examen";
oxfApp.text.oxford_geniox_exam_name = "Nombre";
oxfApp.text.oxford_geniox_exam_grade = "Nota";
oxfApp.text.oxford_geniox_exam_status = "Estado";
oxfApp.text.oxford_geniox_exam_evau_locked_1 = "No tienes acceso a esta prueba.";
oxfApp.text.oxford_geniox_exam_evau_locked_2 = "Este contenido todavía no ha sido desbloqueado por el profesor.";
oxfApp.text.oxford_geniox_accept = "Aceptar";


oxfApp.allExams = [];
oxfApp.newExams = [];


// Get template

oxfApp.getTemplate = function (templateName) {
  switch (templateName) {
    case "1_rectangle":
      return ["1col ox-grid--lowerheight", 1];
      break;
    case "1_left_1_square_right":
      return ["2items", 2];
      break;
    case "1_square_left_1_right":
      return ["2items-reverse", 2];
      break;
    case "2_rectangle":
      return ["2col ox-grid--lowerheight", 2];
      break;
    case "2_left_1_right":
      return ["3items-reverse", 3];
      break;
    case "1_left_2_right":
      return ["3items", 3];
      break;
    case "3rectangle":
      return ["3col ox-grid--lowerheight", 3];
      break;
    case "3_rectangle":
      return ["3col ox-grid--lowerheight", 3];
      break;
    case "3_square":
      return ["3col", 3];
      break;
    case "4_square":
      return ["4col ox-grid--lowerheight", 4];
      break;
    case "4_rectangle":
      return ["4items", 4];
      break;
    case "1_square_left_4_right":
      return ["5items", 5];
      break;
    case "1_rectangle_left_4_right":
      return ["5items-bis", 5];
      break;
    case "6_rectangle":
      return ["6items", 6];
      break;
    case "1_left_2_centre_4right":
      return ["7items", 7];
      break;
    case "1_left_8_right":
      return ["9items", 9];
      break;
    case "12_square":
      return ["12items", 12];
      break;
    case "template1": //OLD
      return ["7items", 7];
      break;
    case "template2": //OLD
      return ["2items-reverse", 2];
      break;
    case "5_square": //NEW
      return ["5items-square", 5];
      break;
    case "4_rectangle_inline": //NEW
      return ["4items-nowrap", 4];
      break;
    case "1_left_1_square_right_ebook": //NEW
      return ["2items", 50];
      break;
    default:
      return [
        oxfApp.config.templateDefault,
        oxfApp.config.templateDefaultTotal,
      ];
  }
};

//Overwrite CLose Activity 

oxfApp.closeActivity = function() {
  var ishtmlBook = $('body').hasClass('body_htmlBook');

  if (blink.isApp && !blink.isOfflinePCApp) {
    blink.rest.closeWindow();
  } else {
    if (window.esPopup) {
      window.top.cerrarIframe()
    } else {
      if (modoactual == 'standalone') {
        window.history.back();
      } else if (ishtmlBook) {
        oxfApp.goHome();
      } else {
        closeActivity();
      }
    }
  }
}

// Go to home
oxfApp.goHome = function() {
  var isBookCover = idclase.toString() === oxfApp.config.coverID;
  if (isBookCover) {
    window.location.hash = oxfApp.config.tree[0].hash;
  } else {
    var bookCoverAction = oxfApp.courseData.units[0].subunits[0].onclickTitle;
    eval(bookCoverAction);
  }
}

// Insert block between elements

oxfApp.addBlockBefore = function(block, id) {
  var refElement = document.getElementById(id);

  if (!refElement) {// Presumably atypical, hence not worrying about creating above
      return null;
  }
  refElement.parentNode.insertBefore(block, refElement);
}

// Get text align
oxfApp.getTextAlign = function (array) {
  if (array.indexOf(oxfApp.config.tagTextCenter) >= 0) {
    return "ox-ta-center";
  } else if (array.indexOf(oxfApp.config.tagTextUpCenter) >= 0) {
    return "ox-ta-center-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpLeft) >= 0) {
    return "ox-ta-left-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpRight) >= 0) {
    return "ox-ta-right-up";
  } else {
    return "ox-ta-left-up";
  }
};

oxfApp.createBarAbove = function () {
  return "";
};

oxfApp.createSearchBar = function () {
  var barSearch =
    '<div class="ox-searchbar"><div class="ox-container"><div class="ox-searchbar__inner"><div class="ox-searchform"><label class="ox-searchform__field"><input type="text" class="ox-searchform__field__input ox--js-triggersearch" placeholder="' +
    oxfApp.text.oxford_zona_recursos_2020_searchPlaceHolder +
    '"><span class="ox-searchform__field__button"></span></label><div class="ox-searchform__results"><div class="ox-searchform__results__inner ox--js-resultslist"></div></div></div></div></div></div>';

  return barSearch;
};

oxfApp.initBookUnitsSidebar = function() {
  var data = oxfApp.courseData;
  var currentBook = -1;
  var currentBookIndex = -1;

  data.units.map((unit, index) => {
    unit.subunits.map((subunit) => {
      if(subunit.id == window.idclase){
        for (n = index; n > 0; n--) {

          var unitTags = data.units[n].tags,
          unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];

          if (unitTagsArray.indexOf(oxfApp.config.tagBlockEbooks) >= 0) {
            currentBook = data.units[n].id;
            currentBookIndex = n;
            return;
          }
        }
      }
    });
  });

  var $bookwrapper = $(".content-wrapper.libro");

  var bookUnits = "";
  var bookThumbs = "";
  var bookResources = "";

  $.each(data.units, function(i, unit) {

    if (i > currentBookIndex) {
      
      var unitTags = unit.tags,
      unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];
      
      if (unitTagsArray.indexOf(oxfApp.config.tagBlockEbook) >= 0) {
        var unitID = unit.id;

        var unitTitle = unit.title,
        onlyVisibleTeachers = unit.onlyVisibleTeachers;
        
        if (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent) {
          var unitItem = '<li><a href="javascript:void(0)" title="'+unitTitle+'" data-target="'+unitID+'">'+unitTitle+'</a></li>';
          bookUnits += unitItem;

          var subunit = unit.subunits[0];
          if (typeof subunit === 'undefined') return;

          var pags = Array.isArray(subunit.pags) ? subunit.pags : [];
          var subunitThumb = "";
          var subunitId = subunit.id;

          $.each(pags, function(i, pag) {
            if (i % 2) {
              return;
            }
            var thumb = (pag) ? pag.thumb : [];
            var pageIndex = i + 1;
            var thumbNext = (pags[pageIndex]) ? pags[pageIndex].thumb : '';
            var page = pag.label;
            var page = (page === null || page === "null") ? "0" : page;
            var pageNext = (pags[pageIndex]) ?  pags[pageIndex].label : '';
            var otherBook = (window.idclase !== Number(subunitId)) ? 'data-onclick="' + subunit.onclickTitle + '"': '';
            var thumbWithPage = '<article class="ox-thumb"><a href="javascript:void(0)" '+otherBook+' class="ox-thumb__inner ox-js--goToPageBook" data-book-id="'+subunitId+'" data-page="'+pageIndex+'"><div class="ox-thumb__media"><img src="'+thumb+'" alt=""><img src="'+thumbNext+'" alt="" /></div><div class="ox-thumb__page">'+oxfApp.text.oxford_geniox_pags + ' ' + page+'-'+pageNext+'</div></a></article>';
            subunitThumb += thumbWithPage;
          });

          var unitThumbs = '<div class="ox-sidebar__thumbs" data-thumbs="'+unitID+'"><div class="ox-sidebar__thumbs__title">'+unitTitle+'</div><div class="ox-thumb__wrapper">'+subunitThumb+'</div></div>';
          bookThumbs += unitThumbs;

          // Resources of the UNIT (siblings subunits)
          var subunits = unit.subunits;
          var resourceList = "";

          $.each(subunits, function(i, resource) {
            if (i > 0) {
              var title = resource.title;
              var type = resource.type;
              var level = resource.level;
              var onClick = resource.onclickTitle;
              var resource = '<li class="ox-sidebar__list__item --'+type+' --level-'+level+'"><a href="javascript:void(0)" onclick="'+onClick+'">'+title+'</a></li>';
              resourceList += resource;
            }

          });

          bookResources += '<ul class="ox-sidebar__list --hidden" data-parent="'+unitID+'">'+resourceList+'</ul>';
        }
        
      } else {
        return false;
      }
      
    }
  });

  var buttonAddRecources = "";
  if (!oxfApp.config.isStudent) {
    buttonAddRecources = '<a href="javascript:void();" class="ox-button ox-button--addresource">'+oxfApp.text.oxford_geniox_addresource+'</a>';
  }

  var bookUnitsSidebarUnits = '<div class="ox-sidebar --hidden" id="ox-BookUnits"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_pageperunit+'</h2><button class="ox-link ox-js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list ox-js--goToUnitList">'+bookUnits+'</ol></div><div class="ox-sidebar__thumbs__wrapper --hidden" id="ox-BookThumbs">'+bookThumbs+'<button class="ox-button ox-button--icon ox-button--icon--close-2 ox-js--closeThumbs"><span>'+oxfApp.text.oxford_geniox_close+'</span></button></div></div>';
  var bookUnitsSidebarResources = '<div class="ox-sidebar --hidden" id="ox-BookResources"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_resourcesperunit+'</h2><button class="ox-link ox-js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list ox-js--openResourcesList">'+bookUnits+'</ol></div><div class="ox-sidebar__footer">'+buttonAddRecources+'</div><div class="ox-sidebar__resources__wrapper --hidden" id="ox-BookResourcesList">'+bookResources+'</div></div>';

  $bookwrapper.append(bookUnitsSidebarUnits).append(bookUnitsSidebarResources);

  blink.events.on('digitalbook:viewerLoaded', (function() {
    if (oxfApp.storage.getItem('currentBookPage') !== null) {
      var page = oxfApp.storage.getItem('currentBookPage');
      bpdf.changePageDesktop.set(page);
      $('[data-page]').parent().removeClass('current');
      $('[data-book-id="'+window.idclase+'"][data-page="'+oxfApp.storage.getItem('currentBookPage')+'"]').parent().addClass('current');
    }
  }));
}

oxfApp.initBookHTML = function () {
  var data = oxfApp.courseData;

  var $bookwrapper = $(".content-wrapper.libro");
  
  var barAbove = oxfApp.createBarAbove(data.title);
  
  var bookMenuIndex =
    '<a href="javascript:void(0)" class="ox-link-icon ox-js--toggleBookUnits">' +
    oxfApp.icons.units +
    oxfApp.text.oxford_geniox_pageperunit +
    "</a>";
  var bookMenuResources =
    '<a href="javascript:void(0)" class="ox-link-icon ox-js--toggleBookResources">' +
    oxfApp.icons.resources +
    oxfApp.text.oxford_geniox_resourcesperunit +
    "</a>";
  var bookMenuPin =
    '<label class="ox-switch"><input type="checkbox" value="ox-show-pin"><span class="ox-switch__slider"></span><span class="ox-switch__label">' +
    oxfApp.text.oxford_geniox_showpins +
    "</span></label>";
  var bookMenuToggle = '<button class="ox-button--toggleBookMenu ox-js--toggleBookMenu" data-text-show="'+oxfApp.text.oxford_geniox_showbookmenu+'" data-text-hide="'+oxfApp.text.oxford_geniox_hidebookmenu+'">'+oxfApp.text.oxford_geniox_showbookmenu+'</button>';

  var bookMenu =
    '<div class="ox-book-navigation --hidden"><div class="ox-book-navigation__section ox-book-navigation__section--first">' +
    bookMenuIndex +
    '</div><div class="ox-book-navigation__section ox-book-navigation__section--middle">' +
    bookMenuResources + bookMenuPin +    
    '</div><div class="ox-book-navigation__section ox-book-navigation__section--last">' +
    bookMenuToggle +
    '</div></div>';


  var $arrows = $(".slider-control"),
    $arrowLeft = $(".slider-control.left"),
    $arrowRight = $(".slider-control.right");

  var arrowLeftDisabled = $arrowLeft.is(".disabled"),
    arrowRightDisabled = $arrowRight.is(".disabled");

  var barNavigation =
    '<div class="ox-navigation-wrapper">' +
    bookMenu +
    "</div>";

  if (arrowLeftDisabled && arrowRightDisabled) {
    $arrows.addClass("ox-hidden");
  }

  $arrowLeft.append(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_prev +
      "</span>"
  );
  $arrowRight.prepend(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_next +
      "</span>"
  );

  var viewnotsupported =
    '<div class="ox-disabledlandscape"><div class="ox-disabledlandscape__inner">' +
    oxfApp.text.oxford_zona_recursos_2020_viewnotsupported +
    "</div></div>";

  //FIX Close button

  $('#close-back-wrapper-button').addClass('ox--js-closeActivity');

  $bookwrapper.prepend(barAbove).append(barNavigation).append(viewnotsupported);

  oxfApp.initBookUnitsSidebar();
};

oxfApp.blockDropdown = function (block) {
  var data = oxfApp.courseData;
  $.each(data.units, function (i, unit) {
    var unitInd = i;
    var isBeforeYouStart = unitInd === oxfApp.beforeYouStartUnit;
    if (!isBeforeYouStart) {
      var unitTags = unit.tags,
        unitTagsArray =
          typeof unitTags !== "undefined" ? unitTags.split(" ") : [];
      $.each(unitTagsArray, function (index, value) {
        value = value.toLowerCase();

        if (oxfApp.startsWith(value, oxfApp.config.nBlockBox)) {
          //nBlocks
          var isDropdown =
            unitTagsArray.indexOf(oxfApp.config.tagDropdown) >= 0;

          if (isDropdown) {
            var currentBlockID = "ox-nblock-" + unitInd;
            var isShown = oxfApp.storage.getItem(currentBlockID)
                ? oxfApp.getBoolean(oxfApp.storage.getItem(currentBlockID))
                : true,
              visibleClass = !isShown ? "" : "ox-visible",
              toggleButtonText = isShown
                ? oxfApp.text.oxford_zona_recursos_2020_hide
                : oxfApp.text.oxford_zona_recursos_2020_show,
              toggleButton =
                '<button class="ox-link ox--js-toggleBlock" data-text-shown="' +
                oxfApp.text.oxford_zona_recursos_2020_hide +
                '" data-text-hidden="' +
                oxfApp.text.oxford_zona_recursos_2020_show +
                '">' +
                toggleButtonText +
                "</button>";

            $("#" + currentBlockID)
              .addClass("ox-module--togglable")
              .addClass(visibleClass)
              .find(".ox-module__header")
              .append(toggleButton);
          }
        } else if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxContent)) {
          //nBlocks content
          var unitID = unit.id;
          var textAlign = oxfApp.getTextAlign(unitTagsArray);
          $('.ox-card__inner[data-unitid="' + unitID + '"]').addClass(
            textAlign
          );
        }
      });
    }
  });
};

oxfApp.blockExams = function() {
  if (!oxfApp.config.isStudent) return;

  var data = oxfApp.courseData;

  var $blockCreated = null;
  var placeholder = 0;
  var $page = $('.ox-page--home');

  $.each(data.units, function (i, unit) {
    var unitTags = unit.tags,
    unitTagsArray = typeof unitTags !== "undefined" ? unitTags.split(" ") : [];

    var isExamGenerator = (unitTagsArray.indexOf(oxfApp.config.examGenerator) >= 0);


    if (isExamGenerator && data.units[i - 1]) {
        placeholder = i - 1;     
        $blockCreated = $('#ox-nblock-'+placeholder+' .ox-module__content .ox-grid');

      return false;
    }

  });

  if (!$blockCreated.length) {
    var unit = oxfApp.courseData.units[placeholder],
        title = unit.title,
        color = (placeholder % 2 == 0) ? oxfApp.config.colorsPairs_1 : oxfApp.config.colorsPairs_2;

      // Get template and background
      var unitTags = unit.tags,
          unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];

      var unitBg = oxfApp.config.backgroundDefault,
          unitBgImage = (typeof unit.image !== 'undefined') ? unit.image : '',
          unitTemplate = oxfApp.config.templateDefault,
          unitTemplateTotal = oxfApp.config.templateDefaultTotal;

      if (unitTagsArray.length) {

        $.each(unitTagsArray, function(index, value) {
          value = value.toLowerCase();

          if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxBg)) {
            unitBg = value.replace(oxfApp.config.nBlockBoxBg, '#');
          } else if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxTemplate)) {
            unitTemplateVal = value.replace(oxfApp.config.nBlockBoxTemplate, '');
            unitTemplate = oxfApp.getTemplate(unitTemplateVal)[0];
            unitTemplateTotal = oxfApp.getTemplate(unitTemplateVal)[1];
          }
        });
      }

      var colorClass = oxfApp.getColorClass(unitBg);
      var $blockCreated = document.createElement('section');
      $blockCreated.className = 'ox-module ox-module--custom ox-module--nblock '+colorClass;
      $blockCreated.id = 'ox-nblock-'+placeholder;
      $blockCreated.innerHTML = '<div class="ox-container"><header class="ox-module__header"><h2 class="ox-title ox-title--2">'+title+'</h2></header><div class="ox-module__content"><div class="ox-grid"></div></div></section>';


      $($blockCreated).css({'background-color': unitBg, 'background-image' : 'url('+unitBgImage+')'}).find('.ox-grid').addClass('ox-grid--'+unitTemplate);

      var isPrepend = false;
      var max = oxfApp.courseData.units.length;
      for (n = placeholder; n < max; n++) {
       
        if ($('#ox-nblock-'+n).length && !isPrepend) {
          
          oxfApp.addBlockBefore($blockCreated, 'ox-nblock-'+n);
          $blockCreated = $($blockCreated).find('.ox-grid');

          isPrepend = true;
        }
      }

      if (!isPrepend) {
        $page[0].appendChild($blockCreated);
        $blockCreated = $($blockCreated).find('.ox-grid');

      }
    
  }

  $.each(data.units, function (i, unit) {
    var unitTags = unit.tags,
        unitTagsArray = typeof unitTags !== "undefined" ? unitTags.split(" ") : [];
    

    var isExamGenerated = (unitTagsArray.indexOf(oxfApp.config.examGenerated) >= 0);
    var isExamOxford = (unitTagsArray.indexOf(oxfApp.config.examOxford) >= 0);
    var isExamOnline = (unitTagsArray.indexOf(oxfApp.config.examsOnline) >= 0);


    var item = unit,
    itemTitle = item.title,
    itemTitle = itemTitle.replace( /\((.+)\)/ , '' ),
    itemID = item.id,
    itemDescription = (typeof item.description.split(';')[0] !== 'undefined') ? item.description.split(';')[0] : item.description,
    itemBackground = item.image,
    itemBackgroundStyle = (typeof itemBackground !== 'undefined' && itemBackground !== '') ? 'background-image: url(\''+itemBackground+'\');' : '',
    itemBackgroundStyleClass = (typeof itemBackground !== 'undefined' && itemBackground !== '') ? 'ox-wimage' : 'ox-noimage',
    itemBg = '',
    gridClass = '',
    itemBgStyle = '';
    var color = (i % 2 == 0) ? oxfApp.config.colorsPairs_1 : oxfApp.config.colorsPairs_2;

    // Get action
    var itemsChildrenLength = item.subunits.length;
    var itemOnclickTitle = (itemsChildrenLength == 1) ? item.subunits[0].onclickTitle : '';
    var itemAction = (itemsChildrenLength == 1) ? 'onclick="'+itemOnclickTitle+'"' : 'data-unitid="'+itemID+'"',
        itemClass = (itemsChildrenLength > 1 || itemsChildrenLength == 0) ? ' ox--js-goto-resourceslist' : '';

    if (isExamOxford && oxfApp.examOxfordData) {

      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);
    }
    
    if (isExamOnline) {
      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);
    }

    if ((isExamGenerated && oxfApp.courseData.hasExams )|| isExamOnline || isExamOxford) {

      var gridLength = $blockCreated.find('.ox-grid__item').length;
 
      var template = (gridLength == 3) ? oxfApp.getTemplate('1_left_2_right')[0] : (gridLength == 2) ? oxfApp.getTemplate('1_left_1_square_right')[0] : oxfApp.getTemplate('1_rectangle')[0];
      $blockCreated.closest('.ox-grid').removeClass(function (index, css) {
        return (css.match (/(^|\s)ox-grid--\S+/g) || []).join(' ');
     }).addClass('ox-grid--'+template);
    }
    

    
  });

}

oxfApp.prepareToEbooks = function () {
  var data = oxfApp.courseData;

  $.each(data.units, function (index, unit) {
    var unitID = unit.id;
    var tags = (typeof unit.tags !== 'undefined') ? unit.tags : [];

    var pattern = oxfApp.config.tagBlockEbook;
    var pattern2 = oxfApp.config.tagBlockEbooks;
    var isEbookContent =
      tags.indexOf(pattern) >= 0 && tags.indexOf(pattern2) < 0;

    if (isEbookContent) {
      var onclick = (unit.subunits.length) ? unit.subunits[0].onclickTitle : 'nothing';
      $('.ox-card__inner[data-unitid="' + unitID + '"]')
        .closest(".ox-grid__item")
        .remove();
      
      $('.ox-card__inner[onclick="' + onclick + '"]')
        .closest(".ox-grid__item:not(:first-child)")
        .remove();

     
    } 
    
    if (index > 1) {
      var prevIndex = index - 1;
      var previousTags = (data.units[prevIndex] && typeof data.units[prevIndex].tags !== 'undefined') ? data.units[prevIndex].tags : [];

      var isAfterEbookContent =
        !isEbookContent &&
        previousTags.indexOf(pattern) >= 0 &&
        previousTags.indexOf(pattern2) < 0;
      
      if (isAfterEbookContent) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]')
          .closest(".ox-grid__item")
          .nextAll(".ox-grid__item--empty")
          .remove();
      }
    }

    var isEbookCover = tags.indexOf(pattern2) >= 0;

    if (isEbookCover) {
      var nextEbook = data.units[index + 1].subunits[0];

      if (nextEbook) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]').removeClass('ox--js-goto-resourceslist').attr('onclick', nextEbook.onclickTitle);
      }
    }
  });
};

oxfApp.secondLevelView = function () {
  var currentHash = window.location.hash.replace('#','');
  if (currentHash.startsWith(oxfApp.config.tree[3].hash)) { // Resources
    $('.ox-page--resourcessection').addClass('loading');
    var unitID = currentHash.replace(oxfApp.config.tree[3].hash, ''),
        unitIDExists = (oxfApp.config.unitsNblockIDs.indexOf(unitID) >= 0);

    if (unitID !== '' && unitID !== null && unitIDExists) {
      var resourceInfo = oxfApp.getResourcesInfo(unitID);
    
      // Resources
      var subunits = resourceInfo[1].data.subunits,
          subunitsItems = '',
          subunitsItemsSkeleton = '';
    
      var backgroundColorImage = '#ffffff';

      var parentTags = resourceInfo[1].data.tags;
      var parentTags = (typeof parentTags !== 'undefined') ? parentTags.split(" ") : [];

      var hasCardsView = parentTags.indexOf(oxfApp.config.cardView) > -1;
      var hasAbstractView = parentTags.indexOf(oxfApp.config.evauAbstracts) > -1;
      var hasEvauExamView = parentTags.indexOf(oxfApp.config.evauExams) > -1;
      var hasExamOnlineView = parentTags.indexOf(oxfApp.config.examsOnline) > -1;

      if (hasCardsView) {

         if (parentTags != null && parentTags.length) {
          $.each(parentTags, function(index, value) {
            value = value.toLowerCase();
            if (oxfApp.startsWith(value, oxfApp.config.boxBg )) {
              backgroundColorImage = value.replace(oxfApp.config.boxBg, '#');
            }
          });
        }

        if (subunits.length) {
          $.each(subunits, function(i, subunit) {
      
            var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                image = subunit.image,
                description = subunit.description;
      
            if (type === 'archivo') {
              var fileurl = subunit.fileurl,
                  type = oxfApp.getFileType(fileurl);
            }
      
            if (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent) {
              subunitsItems += '<article class="ox-resource ox-resource--card --'+type+'"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+onclickTitle+'"><div class="ox-resource__image" style="background-color: '+backgroundColorImage+'; background-image: url('+image+'); "></div><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div></div></a></article>';
            }
      
          });
      
          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--cards"><div class="ox-container"><div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '';
      
        }

      } else if (hasAbstractView) {

         if (parentTags != null && parentTags.length) {
          $.each(parentTags, function(index, value) {
            value = value.toLowerCase();
            if (oxfApp.startsWith(value, oxfApp.config.boxBg )) {
              backgroundColorImage = value.replace(oxfApp.config.boxBg, '#');
            }
          });
        }

        if (subunits.length) {

          var currentUnitTitle = null;
          var currentUnitImage = null;

          $.each(subunits, function(i, subunit) {
            if (subunit.level === "1") {
              currentUnitTitle = subunit.title;
              currentUnitImage = subunit.image;
            }

            var nextSubunit = subunits[i + 1];
            var prevSubunit = subunits[i - 1];
            var examType = (prevSubunit && prevSubunit.level === "6");

            if (subunit.level !== "1" && !examType && subunit.type !== 'archivo') {

                var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                image = currentUnitImage,
                description = subunit.description;
      
                var downloadableSubunit = subunits[i + 2];
                var isDownloadable = (downloadableSubunit) ? downloadableSubunit.type === 'archivo' : false;
                var downloadable = (isDownloadable) ? '<a class="ox-resource__download" href="'+nextSubunit.fileurl+'" download>'+oxfApp.text.oxford_geniox_downloadFile+'</a>' : '';
      
                var badge = '<span class="ox-badge">'+currentUnitTitle+'</span>';

                if (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent) {
                  subunitsItems += '<article class="ox-resource ox-resource--card ox-resource--card--2 --'+type+'"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+onclickTitle+'"><div class="ox-resource__image" style="background-color: '+backgroundColorImage+'; background-image: url('+image+'); ">'+badge+'</div><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div></div></a>'+downloadable+'</article>';
                }
            }
      
          });
  
        }

      } else if (hasEvauExamView) {
        if (subunits.length) {
          var currentUnitTitle = null;

          $.each(subunits, function(i, subunit) {
            if (subunit.level === "1") {
              currentUnitTitle = subunit.title;

              subunitsItems += '<header class="ox-resource-header"><h2 class="ox-resource-header__title">'+currentUnitTitle+'</h2></header>';

            }

            var examType = (subunit.level === "6");

            if (examType) {

                var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                lockStatus = subunit.lock,
                description = subunit.description;

                var visibilityByUser = (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent);
                var lock = (lockStatus !== 8) ? 'unlocked' : 'locked';
                var userType = (oxfApp.config.isStudent) ? 'student' : 'not-student';
                var lockedButton = (!oxfApp.config.isStudent) ? '<button class="ox-button ox-button--lock --'+lock+' ox-js--toggleLock" data-status="'+lock+'"><span class="ox-button__icon --locked">'+oxfApp.icons.lockLocked+'</span><span class="ox-button__icon --unlocked">'+oxfApp.icons.lockUnlock+'</span></button>' : '<button class="ox-button ox-button--lock --'+lock+'" disabled><span class="ox-button__icon --locked">'+oxfApp.icons.lockLocked+'</span><span class="ox-button__icon --unlocked">'+oxfApp.icons.lockUnlock+'</span></button>';
                var viewButton = '<span class="ox-button ox-button--view"><span class="ox-button__icon --lock">'+oxfApp.icons.eye+'</span></span>';
                var onClickbyLockStatus = (lock === 'unlocked') ? 'onclick="'+onclickTitle+'"' : 'onclick="oxfApp.modalEvauExamLocked()"';

                var onClickbyUser = (!oxfApp.config.isStudent) ? 'onclick="'+onclickTitle+'"' : onClickbyLockStatus;
                if (visibilityByUser) {
                  subunitsItems += '<article class="ox-resource ox-resource--card ox-resource--card--3 --'+userType+' --'+type+' --'+lock+'"><a href="javascript:void(0)" class="ox-resource__inner" '+onClickbyUser+'><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div></div>'+viewButton+'</a>'+lockedButton+'</article>';
                }
                
            }
      
          });
      
          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--cards--2"><div class="ox-container"><div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '';
        }

      } else if (hasExamOnlineView) {
        if (subunits.length) {
        
          $.each(subunits, function(i, subunit) {
            

            var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers;      

            var gradeBadge = (oxfApp.config.isStudent) ? oxfApp.getGradeBagde(id) : false,
                gradeBadgeWrapper = (gradeBadge) ? '<span class="ox-resource__grade">'+gradeBadge+'</span>' : '';

            var isLocked = subunit.lock === 8;
            var classLocked = (isLocked) ? '--locked' : '--unlocked';
            var actionsTeachers = (!oxfApp.config.isStudent) ? '<button class="ox-button ox-button--toggleVisibility '+classLocked+'" data-id="'+id+'"><span>'+oxfApp.text.oxford_geniox_toggleVisibility+'</span></button>' : '';
            
            if (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent) {
              subunitsItems += '<article class="ox-resource ox-resource--exam"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+onclickTitle+'"><span class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3></span></a>'+gradeBadgeWrapper+actionsTeachers+'</article>';
            }
        
      
          });

        }
          var resourcesHeader = (oxfApp.config.isStudent) ? '<div class="ox-resourceslist__header"><span>'+oxfApp.text.oxford_geniox_exam_name+'</span><span>'+oxfApp.text.oxford_geniox_exam_grade+'</span></div>' : '<div class="ox-resourceslist__header"><span>'+oxfApp.text.oxford_geniox_exam_name+'</span><span>'+oxfApp.text.oxford_geniox_exam_status+'</span></div>';
      
          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--exams"><div class="ox-container">'+resourcesHeader+'<div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '<section class="ox-resourceslist ox-resourceslist--exams"><div class="ox-container">'+resourcesHeader+'<div class="ox-resourceslist__inner"></div></div></section>';
      }

      var intervalLoaResources = setInterval(function() {
        if ($('.ox-page--resourcessection .ox-resourceslist').length) {
          $('.ox-page--resourcessection .ox-resourceslist').remove();
          $('.ox-page--resourcessection').append(subunitsItemsSkeleton);
          $('.ox-page--resourcessection').removeClass('loading');
          clearInterval(intervalLoaResources);
        }
       
      }, 250);
      
      if (!hasCardsView && !hasAbstractView && !hasEvauExamView && !hasExamOnlineView) {
          $('.ox-page--resourcessection').removeClass('loading');
      }

    }

  }

}

window.addEventListener("hashchange", oxfApp.secondLevelView, false);


oxfApp.loadHomeGeniox = function () {
  $(".ox-module--header").after(oxfApp.createSearchBar());

  var $moduleFLoatingBubble = $("#ox-module-bys");

  var tagsCover = oxfApp.courseData.units[0].tags,
    tagsCoverArray =
      typeof tagsCover !== "undefined" ? tagsCover.split(" ") : [];

  var backgroundColor = "#e1f4f3";
  var borderColor = "#e1f4f3";

  $.each(tagsCoverArray, function (index, value) {
    value = value.toLowerCase();

    if (oxfApp.startsWith(value, oxfApp.config.tagBackgroundColorHelp)) {
      backgroundColor = value.replace(
        oxfApp.config.tagBackgroundColorHelp,
        "#"
      );
    }
    if (oxfApp.startsWith(value, oxfApp.config.tagBorderColorHelp)) {
      borderColor = value.replace(oxfApp.config.tagBorderColorHelp, "#");
    }
  });

  var styleNode = document.createElement("style");
  var styleText = document.createTextNode(
    "#ox-module-bys:not(.ox-visible) {background-color: " +
      backgroundColor +
      "; border-color: " +
      borderColor +
      "}"
  );
  styleNode.appendChild(styleText);
  document.getElementsByTagName("head")[0].appendChild(styleNode);

  var $floatingBubbleButton = $moduleFLoatingBubble.find(".ox--js-toggleBlock");
  $moduleFLoatingBubble
    .addClass("ox-floatingbubble")
    .removeClass("ox-module--togglable");

  $floatingBubbleButton
    .addClass("ox--js-toggleBubble")
    .removeClass("ox--js-toggleBlock")
    .attr("data-text-shown", "Volver")
    .wrapAll(
      '<div class="ox-floatingbubble__footer"><div class="ox-container"></div></div>'
    );

  var $scrollable = $(".ox-page");

  $scrollable.scroll(function () {
    var st = $(this).scrollTop();
    document.documentElement.style.setProperty("--st", st + "px");
  });


  //Dropdown functionality
  oxfApp.blockDropdown();

  // Remove Ebook content and prepare eBook link
  oxfApp.prepareToEbooks();

  // Add notifications
  oxfApp.showExamsNotifications();

  // Add Exam block
  oxfApp.blockExams();

};


oxfApp.getExamsNotifications = function() {
  if (!oxfApp.config.isStudent || !oxfApp.courseData.hasExams) return;

  // Get all the examns 

  var units = oxfApp.courseData.units;
  var studentActivities = window.actividades;

  $.each(units, function(i, unit) {
    var isExams = unit.isExams;
    
    if (isExams) {
      var subunits = unit.subunits;
      $.each(subunits, function(i, subunit) {
      var isVisible = subunit.lock !== 8;
        if (isVisible) {
          var id = subunit.id;
          oxfApp.allExams.push(id);
          if (typeof studentActivities[id] === 'undefined') {
            oxfApp.newExams.push(id);
          }

        }
      })
    }
  });
} 

oxfApp.showExamsNotifications = function() {
  var newExamsLength = oxfApp.newExams.length;

  if (newExamsLength) {
    var target = $('.ox-card .ox--js-goto-generatedexams').parent();
    var badge = '<span class="ox-badge --notification">'+newExamsLength+'</span>';

    target.append(badge);
  }
  
} 


oxfApp.modalEvauExamLocked = function() {
  $('#ox-modal-evauexamlocked').remove();

  var modal = '<div class="ox-modal in ox-modal--lockstatus" id="ox-modal-evauexamlocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_exam_evau_locked_1+'</p><p>'+oxfApp.text.oxford_geniox_exam_evau_locked_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.closeModalCustom(\'ox-modal-evauexamlocked\')">'+oxfApp.text.oxford_geniox_accept+'</button></div></div></div>';

  $('body').append(modal);
}

oxfApp.closeModalCustom = function(id) {
  $('#'+id).remove();
}

//----------------------------------//
//                                  //
//  Document Ready                  //
//                                  //
//----------------------------------//

$(document).ready(function () {
  var intervalLoadHome = setInterval(initGeniox, 250);

  function initGeniox() {
    var coverID = oxfApp.config.coverID;

    if (coverID && oxfApp.courseData !== "") {      
      var isBookCover = idclase.toString() === coverID;

      if (isBookCover) {
        oxfApp.loadHomeGeniox();
        oxfApp.secondLevelView();
        oxfApp.getExamsNotifications();
      }
      
      clearInterval(intervalLoadHome);
    }
  }

  $("body").on("click", ".ox--js-toggleBubble", function (e) {
    e.preventDefault();

    var block = $(this).closest(".ox-floatingbubble"),
      shown = block.hasClass("ox-visible"),
      text = shown
        ? $(this).attr("data-text-hidden")
        : $(this).attr("data-text-shown");

    if (shown) {
      block.removeClass("ox-visible");
      $("body").removeClass("ox-bubbleVisible");
    } else {
      block.addClass("ox-visible");
      $("body").addClass("ox-bubbleVisible");
    }

    $(this).text(text);
  });

  $("body").on("click", ".ox-js--toggleBookMenu", function(e) {
    e.preventDefault();
    var $nav = $(this).closest('.ox-book-navigation');

    if ($nav.hasClass('--hidden')) {
      $nav.removeClass('--hidden');
      $('body').addClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-hide');
      $(this).text(text);
    } else {
      $nav.addClass('--hidden');
      $('body').removeClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-show');
      $(this).text(text);
    }
  });

  $("body").on("click", ".ox-js--toggleBookUnits", function(e) {
    e.preventDefault();
    $('.ox-sidebar:not(#ox-BookUnits)').addClass('--hidden');
    $('#ox-BookUnits').toggleClass('--hidden');

    if (!$('#ox-BookUnits').hasClass('--hidden') && bpdf) {
      $('.ox-js--goToPageBook').parent().removeClass('current');
      var currentPage = bpdf.getVisiblePages()[1];
      $('[data-book-id="'+window.idclase+'"][data-page="'+currentPage+'"]').parent().addClass('current');
    }

  });

  $("body").on("click", ".ox-js--toggleBookResources", function(e) {
    e.preventDefault();
    
    if (!$('#ox-BookResources').hasClass('--hidden')) {
      $('#ox-BookResourcesList').addClass('--hidden');
    }

    $('.ox-sidebar:not(#ox-BookResources)').addClass('--hidden');
    $('#ox-BookResources').toggleClass('--hidden');


  });

  $("body").on("click", ".ox-js--closeSidebar", function(e) {
    e.preventDefault();
    $('.ox-sidebar').addClass('--hidden');
    $('#ox-BookResourcesList').addClass('--hidden');
    $('#ox-BookThumbs').addClass('--hidden');
  });

  $("body").on("click", ".ox-js--closeThumbs", function(e) {
    e.preventDefault();
    $('#ox-BookThumbs').addClass('--hidden');
  });


  $("body").on("click", ".ox-js--openResourcesList a", function(e) {
    e.preventDefault();
    var target = $(this).attr('data-target');
    if ($('[data-parent="'+target+'"]').hasClass('--hidden')) {
      $('#ox-BookResourcesList').removeClass('--hidden');
      $('[data-parent="'+target+'"]').removeClass('--hidden').siblings().addClass('--hidden');
  
    } else {
      $('#ox-BookResourcesList').addClass('--hidden');  
      setTimeout(function() {
        $('[data-parent="'+target+'"]').addClass('--hidden');
      }, 300); 
    }

  });

  $("body").on("click", ".ox-js--goToUnitList a", function(e) {
    e.preventDefault();
    var target = $(this).attr('data-target');
    if ($('#ox-BookThumbs').hasClass('--hidden')) {
      $('#ox-BookThumbs').removeClass('--hidden');
    }

    var offset = ($('[data-thumbs="'+target+'"').length) ? $('[data-thumbs="'+target+'"').offset().top : 0;

    $('#ox-BookThumbs').scrollTop(offset);

  });


  $("body").on("click", ".ox-js--goToPageBook", function(e) {
    e.preventDefault();

    var hasOnclick = $(this).attr('data-onclick');
    var page = $(this).attr('data-page');
    if (hasOnclick) {
      var onclick = $(this).attr('data-onclick');
      var onclickfunction = eval(onclick)
      if (typeof onclickfunction == 'function') {
        onclickfunction()
      }
    } else {
      bpdf.changePageDesktop.set(page);

      $('.ox-js--goToPageBook').removeClass('current');
      $(this).addClass('current');

      $('.ox-sidebar').addClass('--hidden');
      $('#ox-BookThumbs').addClass('--hidden');
    }
    
    oxfApp.storage.setItem('currentBookPage', page);
  });




});
