oxfApp.config.tagDropdown = "block_dropdown";
oxfApp.config.tagTextCenter = "block_text_center";
oxfApp.config.tagTextUpCenter = "block_text_up_center";
oxfApp.config.tagTextUpLeft = "block_text_up_left";
oxfApp.config.tagTextUpRight = "block_text_up_right";
oxfApp.config.tagBackgroundColorHelp = "home_help_background_color_";
oxfApp.config.tagBorderColorHelp = "home_help_border_color_";
oxfApp.config.tagBlockEbook = "block_ebook";
oxfApp.config.tagBlockEbooks = "block_ebooks";

oxfApp.icons.units = '<svg xmlns="http://www.w3.org/2000/svg" width="72.607" height="55.322"><path data-name="Libro tab bar" d="M68.122 48.414h-.672v-2a3.778 3.778 0 0 0-3.942-3.579H55.38a2.042 2.042 0 0 0-2.085-1.684H46.65a2.042 2.042 0 0 0-2.085 1.684h-.656a8.82 8.82 0 0 0-7.583 4.081 8.82 8.82 0 0 0-7.583-4.081H9.1a3.778 3.778 0 0 0-3.942 3.579v2h-.673A4.3 4.3 0 0 0 0 52.486V92.4a4.3 4.3 0 0 0 4.485 4.07h63.637a4.3 4.3 0 0 0 4.485-4.07V52.486a4.3 4.3 0 0 0-4.485-4.072zm-24.213-3.651h.641v12.69a1.847 1.847 0 0 0 3.092 1.178l2.332-2.077 2.326 2.077a1.847 1.847 0 0 0 3.1-1.178v-5.817a1.069 1.069 0 0 0-2.127 0v5.148l-2.023-1.8a1.963 1.963 0 0 0-2.547 0l-2.023 1.8V43.079h6.592v13.159c0 .533.476-4.6 1.063-4.6s1.064.533 1.064 0v-6.875h8.112a1.739 1.739 0 0 1 1.815 1.647v41.823a1.739 1.739 0 0 1-1.815 1.647H37.39V50.635c.026-3.24 2.94-5.872 6.519-5.872zM70.479 92.4a2.26 2.26 0 0 1-2.358 2.141H4.485A2.26 2.26 0 0 1 2.127 92.4V52.486a2.26 2.26 0 0 1 2.358-2.141h.672V79.7a1.018 1.018 0 0 0 1.064.966 1.018 1.018 0 0 0 1.063-.966V46.411A1.739 1.739 0 0 1 9.1 44.763h19.642c3.579 0 6.493 2.632 6.52 5.876V89.88H9.1a1.739 1.739 0 0 1-1.814-1.647V79.7a.751.751 0 0 0-.83-.862c-.588 0-1.3.329-1.3.862v8.535A3.778 3.778 0 0 0 9.1 91.811h54.41a3.778 3.778 0 0 0 3.942-3.579V50.345h.672a2.26 2.26 0 0 1 2.358 2.141z" transform="translate(0 -41.148)" style="fill:#02285c"/></svg>';
oxfApp.icons.resources = '<svg xmlns="http://www.w3.org/2000/svg" width="59.346" height="52.834"><defs><style>.cls-1{fill:#02285c}</style></defs><g id="ICON_contenidos_por_unidades" data-name="ICON contenidos por unidades" transform="translate(-5292.648 -791.102)"><g id="folder" transform="translate(5292.648 791.102)"><g id="Grupo_1216" data-name="Grupo 1216"><path id="Trazado_894" data-name="Trazado 894" class="cls-1" d="M55.39 178.69H3.956A4.1 4.1 0 0 1 0 174.475v-23.186c0-.582.442-.243.989-.243s.989-.338.989.243v23.186a2.048 2.048 0 0 0 1.978 2.108H55.39a2.048 2.048 0 0 0 1.978-2.108V140.75a2.048 2.048 0 0 0-1.978-2.108H3.956a2.048 2.048 0 0 0-1.978 2.108v10.539a1.023 1.023 0 0 1-.989 1.054A1.023 1.023 0 0 1 0 151.289V140.75a4.1 4.1 0 0 1 3.956-4.216H55.39a4.1 4.1 0 0 1 3.956 4.216v33.725a4.1 4.1 0 0 1-3.956 4.216" transform="translate(0 -125.856)"/><path id="Trazado_896" data-name="Trazado 896" class="cls-1" d="M36.264 44.725h51.117V42.96a1.975 1.975 0 0 0-2.13-1.765H55.988a2.4 2.4 0 0 1-1.733-.69l-4.128-4.276a1.149 1.149 0 0 0-.827-.329H38.394a1.975 1.975 0 0 0-2.13 1.765zm52.182 1.765H35.2c-.589 0-1.065 2.507-1.065 2.02V37.664c0-1.947 1.911-3.53 4.26-3.53H49.3a3.456 3.456 0 0 1 2.49.992l4.127 4.274 29.334.028c2.349 0 4.26 1.583 4.26 3.53v2.648a.986.986 0 0 1-1.065.883z" transform="translate(-34.134 -34.134)"/></g></g><path id="Trazado_897" data-name="Trazado 897" d="m221.4 144.324-12.926-8.079a1.616 1.616 0 0 0-2.472 1.37v16.158a1.615 1.615 0 0 0 2.472 1.37l12.926-8.079a1.616 1.616 0 0 0 0-2.74z" transform="translate(5110.242 677.102)" style="fill:none;stroke:#02285c;stroke-width:2px"/></g></svg>';
oxfApp.text.oxford_geniox_pageperunit = "Páginas por unidad";
oxfApp.text.oxford_geniox_resourcesperunit = "Recursos por unidad";
oxfApp.text.oxford_geniox_showpins = "Mostrar pines";
oxfApp.text.oxford_geniox_showbookmenu = "Mostrar menú";
oxfApp.text.oxford_geniox_hidebookmenu = "Ocultar menú";
oxfApp.text.oxford_geniox_close = "Cerrar";
oxfApp.text.oxford_geniox_addresource = "Añade tu recurso";


// Get template

oxfApp.getTemplate = function (templateName) {
  switch (templateName) {
    case "1_rectangle":
      return ["1col ox-grid--lowerheight", 1];
      break;
    case "1_left_1_square_right":
      return ["2items", 2];
      break;
    case "1_square_left_1_right":
      return ["2items-reverse", 2];
      break;
    case "2_rectangle":
      return ["2col ox-grid--lowerheight", 2];
      break;
    case "2_left_1_right":
      return ["3items-reverse", 3];
      break;
    case "1_left_2_right":
      return ["3items", 3];
      break;
    case "3rectangle":
      return ["3col ox-grid--lowerheight", 3];
      break;
    case "3_rectangle":
      return ["3col ox-grid--lowerheight", 3];
      break;
    case "3_square":
      return ["3col", 3];
      break;
    case "4_square":
      return ["4col ox-grid--lowerheight", 4];
      break;
    case "4_rectangle":
      return ["4items", 4];
      break;
    case "1_square_left_4_right":
      return ["5items", 5];
      break;
    case "1_rectangle_left_4_right":
      return ["5items-bis", 5];
      break;
    case "6_rectangle":
      return ["6items", 6];
      break;
    case "1_left_2_centre_4right":
      return ["7items", 7];
      break;
    case "1_left_8_right":
      return ["9items", 9];
      break;
    case "12_square":
      return ["12items", 12];
      break;
    case "template1": //OLD
      return ["7items", 7];
      break;
    case "template2": //OLD
      return ["2items-reverse", 2];
      break;
    case "5_square": //NEW
      return ["5items-square", 5];
      break;
    case "4_rectangle_inline": //NEW
      return ["4items-nowrap", 4];
      break;
    case "1_left_1_square_right_ebook": //NEW
      return ["2items", 50];
      break;
    default:
      return [
        oxfApp.config.templateDefault,
        oxfApp.config.templateDefaultTotal,
      ];
  }
};

// Get text align
oxfApp.getTextAlign = function (array) {
  if (array.indexOf(oxfApp.config.tagTextCenter) >= 0) {
    return "ox-ta-center";
  } else if (array.indexOf(oxfApp.config.tagTextUpCenter) >= 0) {
    return "ox-ta-center-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpLeft) >= 0) {
    return "ox-ta-left-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpRight) >= 0) {
    return "ox-ta-right-up";
  } else {
    return "ox-ta-left-up";
  }
};

oxfApp.createBarAbove = function () {
  return "";
};

oxfApp.createSearchBar = function () {
  var barSearch =
    '<div class="ox-searchbar"><div class="ox-container"><div class="ox-searchbar__inner"><div class="ox-searchform"><label class="ox-searchform__field"><input type="text" class="ox-searchform__field__input ox--js-triggersearch" placeholder="' +
    oxfApp.text.oxford_zona_recursos_2020_searchPlaceHolder +
    '"><span class="ox-searchform__field__button"></span></label><div class="ox-searchform__results"><div class="ox-searchform__results__inner ox--js-resultslist"></div></div></div></div></div></div>';

  return barSearch;
};

oxfApp.initBookUnitsSidebar = function() {
  var data = oxfApp.courseData;
  var currentBook = -1;
  var currentBookIndex = -1;

  data.units.map((unit, index) => {
    unit.subunits.map((subunit) => {
      if(subunit.id == window.idclase){
        for (n = index; n > 0; n--) {

          var unitTags = data.units[n].tags,
          unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];

          if (unitTagsArray.indexOf(oxfApp.config.tagBlockEbooks) >= 0) {
            currentBook = data.units[n].id;
            currentBookIndex = n;
            return;
          }
        }
      }
    });
  });

  var $bookwrapper = $(".content-wrapper.libro");

  var bookUnits = "";
  var bookThumbs = "";
  var bookResources = "";

  $.each(data.units, function(i, unit) {

    if (i > currentBookIndex) {
      
      var unitTags = unit.tags,
      unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];
      
      if (unitTagsArray.indexOf(oxfApp.config.tagBlockEbook) >= 0) {
        var unitID = unit.id;

        var unitTitle = unit.title,
        onlyVisibleTeachers = unit.onlyVisibleTeachers;
        
        if (!onlyVisibleTeachers || onlyVisibleTeachers && !oxfApp.config.isStudent) {
          var unitItem = '<li><a href="javascript:void(0)" title="'+unitTitle+'" data-target="'+unitID+'">'+unitTitle+'</a></li>';
          bookUnits += unitItem;

          var subunit = unit.subunits[0];
          if (typeof subunit === 'undefined') return;

          var pags = Array.isArray(subunit.pags) ? subunit.pags : [];
          var subunitThumb = "";

          $.each(pags, function(i, pag) {
            var thumb = '<article>'+pag+'</article>';
            subunitThumb += thumb;
          });

          var unitThumbs = '<div class="ox-sidebar__thumbs"><div class="ox-sidebar__thumbs__title">'+unitTitle+'</div>'+subunitThumb+'</div>';
          bookThumbs += unitThumbs;

          // Resources of the UNIT (siblings subunits)
          var subunits = unit.subunits;
          console.log(unit.subunits, subunits);
          var resourceList = "";

          $.each(subunits, function(i, resource) {

            var title = resource.title;
            var type = resource.type;
            var onClick = resource.onclickTitle;
            var resource = '<li class="ox-sidebar__list__item --'+type+'"><a href="javascript:void(0)" onClick="'+onClick+'">'+title+'</a></li>';
            resourceList += resource;
  

          });

          bookResources += '<ul class="ox-sidebar__list --hidden" data-parent="'+unitID+'">'+resourceList+'</ul>';
        }
        
      } else {
        return false;
      }
      
    }
  });

  var buttonAddRecources = "";
  if (!oxfApp.config.isStudent) {
    buttonAddRecources = '<a href="javascript:void();" class="ox-button ox-button--addresource">'+oxfApp.text.oxford_geniox_addresource+'</a>';
  }

  var bookUnitsSidebarUnits = '<div class="ox-sidebar --hidden" id="ox-BookUnits"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_pageperunit+'</h2><button class="ox-link js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list js--goToUnitList">'+bookUnits+'</ol></div><div class="ox-sidebar__thumbs__wrapper --hidden">'+bookThumbs+'</div></div>';
  var bookUnitsSidebarResources = '<div class="ox-sidebar --hidden" id="ox-BookResources"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_resourcesperunit+'</h2><button class="ox-link js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list js--openResourcesList">'+bookUnits+'</ol>'+buttonAddRecources+'</div><div class="ox-sidebar__resources__wrapper --hidden" id="ox-BookResourcesList">'+bookResources+'</div></div>';

  $bookwrapper.append(bookUnitsSidebarUnits).append(bookUnitsSidebarResources);
}

oxfApp.initBookHTML = function () {
  var data = oxfApp.courseData;

  var $bookwrapper = $(".content-wrapper.libro");
  
  var barAbove = oxfApp.createBarAbove(data.title);
  
  var bookMenuIndex =
    '<a href="javascript:void(0)" class="ox-link-icon js--toggleBookUnits">' +
    oxfApp.icons.units +
    oxfApp.text.oxford_geniox_pageperunit +
    "</a>";
  var bookMenuResources =
    '<a href="javascript:void(0)" class="ox-link-icon js--toggleBookResources">' +
    oxfApp.icons.resources +
    oxfApp.text.oxford_geniox_resourcesperunit +
    "</a>";
  var bookMenuPin =
    '<label class="ox-switch"><input type="checkbox" value="ox-show-pin"><span class="ox-switch__slider"></span><span class="ox-switch__label">' +
    oxfApp.text.oxford_geniox_showpins +
    "</span></label>";
  var bookMenuToggle = '<button class="ox-button--toggleBookMenu js--toggleBookMenu" data-text-show="'+oxfApp.text.oxford_geniox_showbookmenu+'" data-text-hide="'+oxfApp.text.oxford_geniox_hidebookmenu+'">'+oxfApp.text.oxford_geniox_showbookmenu+'</button>';

  var bookMenu =
    '<div class="ox-book-navigation --hidden"><div class="ox-book-navigation__section ox-book-navigation__section--first">' +
    bookMenuIndex +
    '</div><div class="ox-book-navigation__section ox-book-navigation__section--middle">' +
    bookMenuResources + bookMenuPin +    
    '</div><div class="ox-book-navigation__section ox-book-navigation__section--last">' +
    bookMenuToggle +
    '</div></div>';


  var $arrows = $(".slider-control"),
    $arrowLeft = $(".slider-control.left"),
    $arrowRight = $(".slider-control.right");

  var arrowLeftDisabled = $arrowLeft.is(".disabled"),
    arrowRightDisabled = $arrowRight.is(".disabled");

  var barNavigation =
    '<div class="ox-navigation-wrapper">' +
    bookMenu +
    "</div>";

  if (arrowLeftDisabled && arrowRightDisabled) {
    $arrows.addClass("ox-hidden");
  }

  $arrowLeft.append(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_prev +
      "</span>"
  );
  $arrowRight.prepend(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_next +
      "</span>"
  );

  var viewnotsupported =
    '<div class="ox-disabledlandscape"><div class="ox-disabledlandscape__inner">' +
    oxfApp.text.oxford_zona_recursos_2020_viewnotsupported +
    "</div></div>";

  $bookwrapper.prepend(barAbove).append(barNavigation).append(viewnotsupported);

  oxfApp.initBookUnitsSidebar();
};

oxfApp.blockDropdown = function (block) {
  var data = oxfApp.courseData;
  $.each(data.units, function (i, unit) {
    var unitInd = i;
    var isBeforeYouStart = unitInd === oxfApp.beforeYouStartUnit;
    if (!isBeforeYouStart) {
      var unitTags = unit.tags,
        unitTagsArray =
          typeof unitTags !== "undefined" ? unitTags.split(" ") : [];
      $.each(unitTagsArray, function (index, value) {
        value = value.toLowerCase();

        if (oxfApp.startsWith(value, oxfApp.config.nBlockBox)) {
          //nBlocks
          var isDropdown =
            unitTagsArray.indexOf(oxfApp.config.tagDropdown) >= 0;

          if (isDropdown) {
            var currentBlockID = "ox-nblock-" + unitInd;
            var isShown = oxfApp.storage.getItem(currentBlockID)
                ? oxfApp.getBoolean(oxfApp.storage.getItem(currentBlockID))
                : true,
              visibleClass = !isShown ? "" : "ox-visible",
              toggleButtonText = isShown
                ? oxfApp.text.oxford_zona_recursos_2020_hide
                : oxfApp.text.oxford_zona_recursos_2020_show,
              toggleButton =
                '<button class="ox-link ox--js-toggleBlock" data-text-shown="' +
                oxfApp.text.oxford_zona_recursos_2020_hide +
                '" data-text-hidden="' +
                oxfApp.text.oxford_zona_recursos_2020_show +
                '">' +
                toggleButtonText +
                "</button>";

            $("#" + currentBlockID)
              .addClass("ox-module--togglable")
              .addClass(visibleClass)
              .find(".ox-module__header")
              .append(toggleButton);
          }
        } else if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxContent)) {
          //nBlocks content
          var unitID = unit.id;
          var textAlign = oxfApp.getTextAlign(unitTagsArray);
          $('.ox-card__inner[data-unitid="' + unitID + '"]').addClass(
            textAlign
          );
        }
      });
    }
  });
};

oxfApp.prepareToEbooks = function () {
  var data = oxfApp.courseData;

  $.each(data.units, function (index, unit) {
    var unitID = unit.id;
    var tags = unit.tags;

    var pattern = oxfApp.config.tagBlockEbook;
    var pattern2 = oxfApp.config.tagBlockEbooks;
    var isEbookContent =
      tags.indexOf(pattern) >= 0 && tags.indexOf(pattern2) < 0;

    if (isEbookContent) {
      $('.ox-card__inner[data-unitid="' + unitID + '"]')
        .closest(".ox-grid__item")
        .remove();
    } else if (index > 1) {
      var prevIndex = index - 1;
      var previousTags = data.units[prevIndex].tags;

      var isAfterEbookContent =
        !isEbookContent &&
        previousTags.indexOf(pattern) >= 0 &&
        previousTags.indexOf(pattern2) < 0;

      if (isAfterEbookContent) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]')
          .closest(".ox-grid__item")
          .nextAll(".ox-grid__item--empty")
          .remove();
      }
    }

    var isEbookCover = tags.indexOf(pattern2) >= 0;

    if (isEbookCover) {
      var nextEbook = data.units[index + 1].subunits[0];

      if (nextEbook) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]').removeClass('ox--js-goto-resourceslist').attr('onclick', nextEbook.onclickTitle);
      }
    }
  });
};

oxfApp.loadHomeGeniox = function () {
  $(".ox-module--header").after(oxfApp.createSearchBar());

  var $moduleFLoatingBubble = $("#ox-module-bys");

  var tagsCover = oxfApp.courseData.units[0].tags,
    tagsCoverArray =
      typeof tagsCover !== "undefined" ? tagsCover.split(" ") : [];

  var backgroundColor = "#e1f4f3";
  var borderColor = "#e1f4f3";

  $.each(tagsCoverArray, function (index, value) {
    value = value.toLowerCase();

    if (oxfApp.startsWith(value, oxfApp.config.tagBackgroundColorHelp)) {
      backgroundColor = value.replace(
        oxfApp.config.tagBackgroundColorHelp,
        "#"
      );
    }
    if (oxfApp.startsWith(value, oxfApp.config.tagBorderColorHelp)) {
      borderColor = value.replace(oxfApp.config.tagBorderColorHelp, "#");
    }
  });

  var styleNode = document.createElement("style");
  var styleText = document.createTextNode(
    "#ox-module-bys:not(.ox-visible) {background-color: " +
      backgroundColor +
      "; border-color: " +
      borderColor +
      "}"
  );
  styleNode.appendChild(styleText);
  document.getElementsByTagName("head")[0].appendChild(styleNode);

  var $floatingBubbleButton = $moduleFLoatingBubble.find(".ox--js-toggleBlock");
  $moduleFLoatingBubble
    .addClass("ox-floatingbubble")
    .removeClass("ox-module--togglable");

  $floatingBubbleButton
    .addClass("ox--js-toggleBubble")
    .removeClass("ox--js-toggleBlock")
    .attr("data-text-shown", "Volver")
    .wrapAll(
      '<div class="ox-floatingbubble__footer"><div class="ox-container"></div></div>'
    );

  var $scrollable = $(".ox-page");

  $scrollable.scroll(function () {
    var st = $(this).scrollTop();
    document.documentElement.style.setProperty("--st", st + "px");
  });

  //Dropdown functionality
  oxfApp.blockDropdown();

  // Remove Ebook content and prepare eBook link
  oxfApp.prepareToEbooks();
};

//----------------------------------//
//                                  //
//  Document Ready                  //
//                                  //
//----------------------------------//

$(document).ready(function () {
  var intervalLoadHome = setInterval(initGeniox, 250);

  function initGeniox() {
    var coverID = oxfApp.config.coverID;

    if (coverID && oxfApp.courseData !== "") {
      var isBookCover = idclase.toString() === coverID;

      if (isBookCover) {
        oxfApp.loadHomeGeniox();
      }
      clearInterval(intervalLoadHome);
    }
  }

  $("body").on("click", ".ox--js-toggleBubble", function (e) {
    e.preventDefault();

    var block = $(this).closest(".ox-floatingbubble"),
      shown = block.hasClass("ox-visible"),
      text = shown
        ? $(this).attr("data-text-hidden")
        : $(this).attr("data-text-shown");

    if (shown) {
      block.removeClass("ox-visible");
      $("body").removeClass("ox-bubbleVisible");
    } else {
      block.addClass("ox-visible");
      $("body").addClass("ox-bubbleVisible");
    }

    $(this).text(text);
  });

  $("body").on("click", ".js--toggleBookMenu", function(e) {
    e.preventDefault();
    var $nav = $(this).closest('.ox-book-navigation');

    if ($nav.hasClass('--hidden')) {
      $nav.removeClass('--hidden');
      $('body').addClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-hide');
      $(this).text(text);
    } else {
      $nav.addClass('--hidden');
      $('body').removeClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-show');
      $(this).text(text);
    }
  });

  $("body").on("click", ".js--toggleBookUnits", function(e) {
    e.preventDefault();
    $('.ox-sidebar:not(#ox-BookUnits)').addClass('--hidden');
    $('#ox-BookUnits').toggleClass('--hidden');
  });

  $("body").on("click", ".js--toggleBookResources", function(e) {
    e.preventDefault();
    
    if (!$('#ox-BookResources').hasClass('--hidden')) {
      $('#ox-BookResourcesList').addClass('--hidden');
    }

    $('.ox-sidebar:not(#ox-BookResources)').addClass('--hidden');
    $('#ox-BookResources').toggleClass('--hidden');


  });

  $("body").on("click", ".js--closeSidebar", function(e) {
    e.preventDefault();
    $('.ox-sidebar').addClass('--hidden');
    $('#ox-BookResourcesList').addClass('--hidden')
  });


  $("body").on("click", ".js--openResourcesList a", function(e) {
    e.preventDefault();
    var target = $(this).attr('data-target');
    if ($('[data-parent="'+target+'"]').hasClass('--hidden')) {
      $('#ox-BookResourcesList').removeClass('--hidden');
      $('[data-parent="'+target+'"]').removeClass('--hidden').siblings().addClass('--hidden');
  
    } else {
      $('#ox-BookResourcesList').addClass('--hidden');  
      setTimeout(function() {
        $('[data-parent="'+target+'"]').addClass('--hidden');
      }, 300); 
    }

  });


});
